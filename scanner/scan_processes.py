from process_management import get_programs
from checks import check_path
from db_ops import check_signature_in_db
from hashing import get_file_hash_sha256
from process_management import terminate
from delete_files import delete_files
from remove_exec_permission import remove_exec_permission

# Check for viruses in the programs that have currently running processes 		O(N * M) N is number of programs and M is number of blocks in hashing function
def scan_processes():
	num_terminated = 0
	num_prevented = 0
	detected_files = []
	processes = get_programs()		# o(N) N is number of programs that have currently running processes
	num_all = len(processes)
	
	for process in processes:		# O(N * M)
		path = process.exe()
		if(check_path(path)):
			hash = get_file_hash_sha256(path) 		# O(M) M is number of blocks
			if(check_signature_in_db(hash)):
				detected_files.append(path)			# O(1)
				print("\n")
				print("%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%")
				print("Program (" + path + ") matches a signature! Terminating....")
				# Terminating the process
				if(terminate(process)):				# O(1)
					num_terminated += 1
					print("Program (" + path + ") is terminated successfully!")
				else:
					print("Program (" + path + ") is NOT terminated!")
				print("Preventing the program from being executed again....")
				# removing execution permission
				if(remove_exec_permission(path)):
					num_prevented += 1
					print("Program (" + path + ") is prevented from being executed successfully!")
				else:
					print("Program (" + path + ") is NOT prevented from being executed!")
				print("%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%")
				print("\n")
			else:
				print(path + " is CLEAN")

	print("\n\nNumber of programs scanned: " + str(num_all))
	print("Number of clean programs: " + str(num_all - len(detected_files)))
	print("Number of malicious programs: " + str(len(detected_files)))
	print("Number of malicious programs terminated: " + str(num_terminated))
	print("Number of malicious programs prevented from being executed: " + str(num_prevented))
	print("Number of malicious programs NOT terminated: " + str(len(detected_files) - num_terminated))
	print("Number of malicious programs NOT prevented from being executed: " + str(len(detected_files) - num_prevented))

	# Deleting malicious programs
	if(len(detected_files) > 0):
		delete_files(detected_files)	# O(X) X is number of files we want to delete
