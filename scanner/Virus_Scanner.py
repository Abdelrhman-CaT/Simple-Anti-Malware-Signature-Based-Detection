import re, signal, subprocess, atexit, hashlib, sqlite3, psutil, os, sys, time
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler

###############################################################################################################################################

# Database initialization
if not(os.path.exists('./SIGNATURES.db')):
	db = sqlite3.connect('SIGNATURES.db', check_same_thread=False)
	db.execute('''CREATE TABLE SIGNATURES
          (SIGN CHAR(64) PRIMARY KEY     NOT NULL
         );''')
	db.close()

db = sqlite3.connect('SIGNATURES.db', check_same_thread=False)
db.execute('''CREATE TABLE IF NOT EXISTS SIGNATURES
          (SIGN CHAR(64) PRIMARY KEY     NOT NULL
         );''')

###############################################################################################################################################

# Interrupt handler
def summary_interrupt(signal, frame):
    print("\n\nBye!")
    sys.exit(0)

signal.signal(signal.SIGINT, summary_interrupt)

###############################################################################################################################################

# Check path validity for files
def check_path(path):
	if(os.path.exists(path)):
		if(os.path.isfile(path)):
			return True
		else:
			return False
	else:
		return False

def check_path_directory(path):
	if(os.path.exists(path)):
		if(os.path.isdir(path)):
			return True 
		else:
			return False
	else:
		return False

# Terminate a program
def terminate(process):
	try:
		process.terminate()
		return True
	except psutil.Error as e:
		return False
	
# Add a signature to the db
def add_signature(signature):
	params = [signature]
	try:
		db.execute('''INSERT INTO SIGNATURES VALUES(?);''', params)
		db.commit()
		return False
	except sqlite3.Error as e:
		return e

# Delete a signature from the db
def delete_signature(signature):
	params = [signature]
	try:
		db.execute('''DELETE FROM SIGNATURES WHERE SIGN=?''', params)
		db.commit()
		return False
	except sqlite3.Error as e:
		return e

# Check if the signature is in the db
def check_signature_in_db(signature):
	params = [signature]
	query = db.execute('''SELECT * FROM SIGNATURES WHERE SIGN=?;''', params)
	res = query.fetchall()
	if(len(res) == 0):
		return False
	else:
		return True

# Get hash values for a file using sha256
def get_file_hash_sha256(file):
	sha256_hash = hashlib.sha256()
	with open(file,"rb") as f:
		for block_of_512_bytes in iter(lambda: f.read(512),b""):
				sha256_hash.update(block_of_512_bytes)
		return sha256_hash.hexdigest()

# Get all programs that have currently running processes
def get_programs():
	programs = []
	counter = 0

	for process in psutil.process_iter ():
		if(counter == 0):
			programs.append(process)
			counter += 1
		elif(process.exe() == ""):
			continue
		elif(process.exe() == programs[counter - 1].exe()):
			continue
		else:
			programs.append(process)
			counter += 1
	return programs

# Check for viruses in the programs that have currently running processes
def scan_processes():
	num_infected = 0
	num_terminated = 0
	detected_files = []
	processes = get_programs()
	num_all = len(processes)
	
	for process in processes:
		path = process.exe()
		if(check_path(path)):
			hash = get_file_hash_sha256(path)
			if(check_signature_in_db(hash)):
				num_infected += 1
				detected_files.append(path)
				print("\n")
				print("%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%")
				print("Program (" + path + ") matches a signature! Terminating....")
				if(terminate(process)):
					num_terminated += 1
					print("Program (" + path + ") is terminated successfully!")
				else:
					print("Program (" + path + ") is NOT terminated!")
				print("%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%")
				print("\n")
			else:
				print(path + " is CLEAN")

	print("\n\nNumber of programs scanned: " + str(num_all))
	print("Number of clean programs: " + str(num_all - num_infected))
	print("Number of malicious programs: " + str(num_infected))
	print("Number of malicious programs terminated: " + str(num_terminated))
	
	# Deleting malicious programs
	if(num_infected > 0):
		global decision
		while(True):
			decision = input("\n\nDo you want to delete all malicious programs (Y/n)?")
			if(decision == "Y" or decision == "y" or decision == "n" or decision == "N" or decision == ""):
				break
		if(decision == "y" or decision == "Y" or decision == ""):
			# Deleting all malicious files
			num_all = len(detected_files)
			num_failed_to_delete = 0
			print("\nDeleting all files ...")
			for file in detected_files:
				try:
					os.remove(file)
					print("Program (" + file + ") is deleted successfully!")
				except OSError:
					num_failed_to_delete += 1
					print("Program (" + file + ") is NOT deleted!")
			
			print("\n\nNumber of malicious programs deleted: " + str(num_all-num_failed_to_delete))
			print("Number of malicious programs NOT deleted: " + str(num_failed_to_delete))
		
		elif(decision == "n" or decision == "N"):
			print("The malicious programs are NOT deleted!")
	
# Mark a file as a virus
def mark_as_virus(file):
	file_sig = get_file_hash_sha256(file)
	result = add_signature(file_sig)
	if(result == False):
		return True
	else:
		return False

# Unmark a file from being a virus
def unmark(file):
	file_sig = get_file_hash_sha256(file)
	result = delete_signature(file_sig)
	return result

# Get file name from file path
def get_file_name_from_path(path):
	elements = path.split("/")
	return elements[len(elements) - 1]

# Get the process run by a specific file
def get_process_run_by_file(file_name):
	for process in psutil.process_iter ():
		if(re.search(file_name + "$", str(process.exe()))):
			return process
	return False

# Scan a list of files
def scan_files(files):
	num_all = len(files)
	num_detected = 0
	num_clean = 0
	num_detected_with_process = 0
	num_detected_with_no_process = 0
	num_detected_with_process_terminated = 0
	num_detected_with_process_non_terminated = 0
	detected_files = []

	for file in files:
		if(check_path(file)):
			hash_val = get_file_hash_sha256(file)
			file = os.path.abspath(file)
			if(check_signature_in_db(hash_val)):
				print("\n")
				print("%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%")
				num_detected += 1
				detected_files.append(file)
				print("file (" + file + ") matches a signature. Checking if the file has a running process")
				file_name = get_file_name_from_path(file)
				process = get_process_run_by_file(file_name)
				if(process):
					num_detected_with_process += 1
					print("The file has a running process. Terminating the process...")
					if(terminate(process)):
						num_detected_with_process_terminated += 1
						print("The process is terminated successfully")
						print("%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%")
						print("\n")
					else:
						num_detected_with_process_non_terminated += 1
						print("The process is NOT terminated")
						print("%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%")
						print("\n")
				else:
					num_detected_with_no_process += 1
					print("There are no running processes by this file")
					print("%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%")
					print("\n")
			else:
				num_clean += 1
				print("The file " + file + " is CLEAN")

	global decision
	if(num_all > 1):
		print("\n\nNumber of files scanned: " + str(num_all))
		print("Number of clean files: " + str(num_clean))
		print("Number of malicious files: " + str(num_detected))
		print("Number of malicious files having running processess: " + str(num_detected_with_process))
		print("Number of malicious files having no running processess: " + str(num_detected_with_no_process))
		print("Number of malicious files having their running processes terminated: " + str(num_detected_with_process_terminated))
		print("Number of malicious files having their running processes Not terminated: " + str(num_detected_with_process_non_terminated))

		# Deleting malicious programs
		if(num_detected > 0):
			while(True):
				decision = input("\n\nDo you want to delete all malicious files (Y/n)?")
				if(decision == "Y" or decision == "y" or decision == "n" or decision == "N" or decision == ""):
					break
			if(decision == "y" or decision == "Y" or decision == ""):
				# Deleting all malicious files
				num_all = len(detected_files)
				num_failed_to_delete = 0
				print("\nDeleting all files ...")
				for file in detected_files:
					try:
						os.remove(file)
						print("File (" + file + ") is deleted successfully!")
					except OSError:
						num_failed_to_delete += 1
						print("File (" + file + ") is NOT deleted!")
				
				print("\n\nNumber of malicious files deleted: " + str(num_all-num_failed_to_delete))
				print("Number of malicious files NOT deleted: " + str(num_failed_to_delete))
			
			elif(decision == "n" or decision == "N"):
				print("The malicious files are NOT deleted!")

	elif num_all == 1:
		# Deleting the malicious program
		if(num_detected == 1):
			while(True):
				decision = input("\n\nDo you want to delete this file (Y/n)?")
				if(decision == "Y" or decision == "y" or decision == "n" or decision == "N" or decision == ""):
					break
			if(decision == "y" or decision == "Y" or decision == ""):
				# Deleting all malicious files
				print("\nDeleting the file ...")
				file = detected_files[0]	
				try:
					os.remove(file)
					print("File (" + file + ") is deleted successfully!")
				except OSError:
					num_failed_to_delete += 1
					print("File (" + file + ") is NOT deleted!")

			elif(decision == "n" or decision == "N"):
				print("The file is NOT deleted!")

		
# Get the list of newly created files in the last m minutes
def Get_new_files_created_or_modified_in_minutes(directory, m):
	cmd = "find " + directory + " -type f -cmin -" + m
	files = subprocess.check_output(cmd, shell=True)
	files = files.decode("UTF-8")
	files = files.split("\n")
	file_list = []
	for file in files:
		if not(file == ""):
			file_list.append(file)
	return file_list

# Check if the string represents a number
def is_number(str):
    try:
        float(str)
        return True
    except ValueError:
        return False

# check if the file is being used by another process
def check_if_file_is_used_by_another_process(file):
	for process in psutil.process_iter():
		open_files = process.open_files()
		for f in open_files:
			if(f.path == file):
				return False
	return True

# Monitoring new files as soon as they are created
class File_Handler(FileSystemEventHandler):
    def on_created(self, event):
        file = [event.src_path]
        if(check_path(file[0])):
        	while(True):
        		if(check_if_file_is_used_by_another_process(file[0])):
        			break
        	if(check_path(file[0])):
        		#print(file[0] + " Hash: " + get_file_hash_sha256(file[0]))
        		scan_files(file)

###############################################################################################################################################

# Main flow

while(True):
	op = input('''Specify your operation:\n-----------------------
1: Add a SHA-256 signature to the database
2: Delete a signature from the database
3: Scan the processes in the system
4: Get the hash value of a specific file
5: Mark a file as a virus
6: Unmark a file from being a virus
7: Scan a certain file
8: Scan the newly created or modified files in the system within a specified number of minutes
9: Monitor and scan new files as soon as they are created
10: Exit

Your choice is: ''')
	print("\n")

	if(op == '1'):
		signature = input("Enter the signature to add: ")
		signature = signature.replace(" ", "")
		if(len(signature) == 64):
			result = add_signature(signature)
			if(result == False):
				print("Signature Added Successfully")
			else:
				print("Failed To Add The Signature ( " + str(result) + " )")
		else:
			print("Invalid SHA-256 Signature!")
		print("\n*******************************************************\n")
	
	elif(op == '2'):
		signature = input("Enter the signature to delete: ")
		result = delete_signature(signature)
		if(result == False):
			print("Signature Deleted Successfully")
		else:
			print("Failed To Delete The Signature ( " + str(result) + " )")
		print("\n*******************************************************\n")
	
	elif(op == '3'):
		print("SCANNING")
		print("------------------")
		scan_processes()
		print("\n*******************************************************\n")
	
	elif(op == '4'):
		file = input("Enter the path of the file: ")
		if(check_path(file)):
			hash_val = get_file_hash_sha256(file)
			print("The Hash Value Is: " + hash_val)
		else:
			print("This Path Is NOT A Valid File Path!")
			
		print("\n*******************************************************\n")
	
	elif(op == '5'):
		file = input("Enter the path of the file: ")
		if(check_path(file)):
			if(mark_as_virus(file)):
				print("The File Is Successfully Marked As A Virus")
			else:
				print("The File Signature Is Already Stored In The Database!")
		else:
			print("This Path Is NOT A Valid File Path!")

		print("\n*******************************************************\n")
	
	elif(op == '6'):
		file = input("Enter the path of the file: ")
		if(check_path(file)):
			result = unmark(file)
			if(result == False):
				print("The File Is Successfully Unmarked From Being A Virus")
			else:
				print(result)
		else:
			print("This Path Is NOT A Valid File Path!")

		print("\n*******************************************************\n")

	elif(op == '7'):
		file = input("Enter the path of the file: ")
		print("\n")
		if(check_path(file)):
			files = [file]
			scan_files(files)
		else:
			print("This Path Is NOT A Valid File Path!")

		print("\n*******************************************************\n")

	elif(op == '8'):
		print("SCANNING")
		print("------------------")
		directory = input("Enter the path of the directory: ")
		if(check_path_directory(directory)):
			minutes = input("Enter number of minutes: ")
			print("\n")
			if(is_number(minutes)):
				mins = float(minutes)
				if(mins > 0):
					files = Get_new_files_created_or_modified_in_minutes(directory ,str(mins))
					scan_files(files)
				else:
					print("Invalid Value For Minutes!")
			else:
				print("Invalid Value For Minutes!")
		else:
			print("This Path Is NOT A Valid Directory Path!")
		
		print("\n*******************************************************\n")

	elif(op == '9'):
		target_path = input("Enter the path of the directory: ")
		if(check_path_directory(target_path)):
			absolute_path = os.path.abspath(target_path)
			print("\nWAITING FOR NEW FILES IN ( " + absolute_path + " )")
			print("-----------------------------------------------------------------------")
			observer = Observer()
			event_handler = File_Handler()
			observer.schedule(event_handler, path=absolute_path, recursive=True)
			observer.start()

			try:
				while(True):
					time.sleep(1)
			except KeyboardInterrupt:
				observer.stop()

			observer.join()
		else:
			print("This Path Is NOT A Valid Directory Path!")

		print("\n*******************************************************\n")

	elif(op == '10'):
		break
	else:
		print("Invalid operation!")
		print("\n*******************************************************\n")

###############################################################################################################################################

db.close();

# Exit handler 

def summary_exit():
	print("Bye!")

atexit.register(summary_exit)